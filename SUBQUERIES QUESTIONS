1ï¸âƒ£ IN Subquery
â“ Question

Find the film_id and title of films that were rented on 2005-05-29.

âœ… Answer
SELECT DISTINCT f.film_id, f.title
FROM film f
JOIN inventory i
  ON f.film_id = i.film_id
WHERE i.inventory_id IN (
    SELECT r.inventory_id
    FROM rental r
    WHERE DATE(r.rental_date) = '2005-05-29'
)
ORDER BY f.film_id;

ğŸ” Concept Used

Subquery in WHERE

IN for list comparison

Handling TIMESTAMP vs DATE

2ï¸âƒ£ Simple EXISTS
â“ Question

List customers who have made at least one payment.

âœ… Answer
SELECT c.first_name, c.last_name
FROM customer c
WHERE EXISTS (
    SELECT 1
    FROM payment p
    WHERE p.customer_id = c.customer_id
);

ğŸ” Concept Used

EXISTS for existence check

Correlation using customer_id

3ï¸âƒ£ Correlated EXISTS
â“ Question

Find customers who have made a payment greater than 10.

âœ… Answer
SELECT c.first_name, c.last_name
FROM customer c
WHERE EXISTS (
    SELECT 1
    FROM payment p
    WHERE p.customer_id = c.customer_id
      AND p.amount > 10
);

ğŸ” Concept Used

Correlated subquery

Conditional existence check

4ï¸âƒ£ Subquery with Aggregate (Non-Correlated)
â“ Question

Find all payments that are greater than the average payment amount.

âœ… Answer
SELECT *
FROM payment
WHERE amount > (
    SELECT AVG(amount)
    FROM payment
);

ğŸ” Concept Used

Aggregate function inside subquery

Non-correlated subquery

Scalar comparison

5ï¸âƒ£ Subquery in SELECT Clause
â“ Question

Show each customerâ€™s first name, last name, and total number of payments made.

âœ… Answer
SELECT
    c.first_name,
    c.last_name,
    (
        SELECT COUNT(*)
        FROM payment p
        WHERE p.customer_id = c.customer_id
    ) AS total_payments
FROM customer c;

ğŸ” Concept Used

Subquery in SELECT clause

Correlated subquery

One value returned per outer 



-- 6ï¸âƒ£ Subquery in FROM Clause (Derived Table)
-- Find customers whose average payment amount is greater than 5.

FIRST WAY 

-- SELECT c.first_name, c.last_name
-- FROM customer c
-- JOIN (
--     SELECT customer_id, AVG(amount) AS avg_amount
--     FROM payment
--     GROUP BY customer_id
-- ) p
--   ON c.customer_id = p.customer_id
-- WHERE p.avg_amount > 5;


SECOND WAY 

SELECT c.first_name, c.last_name
FROM customer AS c
WHERE (
    SELECT AVG(p.amount)
    FROM payment AS p
    WHERE c.customer_id = p.customer_id
) > 5;

Yep ğŸ˜„ I got you â€” and quick heads-up before I drop it:

ğŸ‘‰ **I wonâ€™t use a writing block here** because this includes **SQL code**, and per rules that must stay in normal chat with code blocks.
But this is **100% GitHub-ready Markdown** â€” you can copy-paste it directly into your repo.

---

# ğŸ“˜ SQL Subqueries â€” Advanced (Last 5 Topics)

These questions focus on **FROM-clause subqueries, correlated subqueries, and multi-level aggregation**.
Difficulty: **Medium â†’ Advanced â†’ Interview-Level**

---

## 6ï¸âƒ£ Correlated Subquery with Aggregate (SELECT / WHERE)

### â“ Question

Find customers whose **average payment amount** is greater than `5`.

### ğŸ§  Concept

* Subquery runs **per row** of the outer query
* Uses **correlation** with `customer_id`

### âœ… Solution

```sql
SELECT c.first_name, c.last_name
FROM customer AS c
WHERE (
    SELECT AVG(p.amount)
    FROM payment AS p
    WHERE p.customer_id = c.customer_id
) > 5;
```

### ğŸ“Œ When to use

* When the calculation depends on **each row of the outer table**
* Simple logic, readable, but can be slower on large data

---

## 7ï¸âƒ£ FROM-Clause Subquery (Derived Table)

### â“ Question

Find customers whose **average payment amount** is greater than `5`.

### ğŸ§  Concept

* Pre-aggregate data first
* Then join with main table
* More **performance-friendly**

### âœ… Solution

```sql
SELECT c.first_name, c.last_name
FROM customer AS c
JOIN (
    SELECT customer_id, AVG(amount) AS avg_amount
    FROM payment
    GROUP BY customer_id
) p
ON c.customer_id = p.customer_id
WHERE p.avg_amount > 5;
```

### ğŸ“Œ When to use

* When aggregation can be done **once**
* Best practice for analytics queries

---

## 8ï¸âƒ£ FROM-Clause Subquery with COUNT

### â“ Question

Find customers who have made **more than 10 payments**.

### âœ… Solution

```sql
SELECT c.first_name, c.last_name
FROM customer c
JOIN (
    SELECT customer_id, COUNT(*) AS total_payments
    FROM payment
    GROUP BY customer_id
) p
ON c.customer_id = p.customer_id
WHERE p.total_payments > 10;
```

### ğŸ“Œ Key takeaway

* FROM subqueries are perfect for **ranking, thresholds, filters**

---

## 9ï¸âƒ£ FROM-Clause Subquery with MAX

### â“ Question

Find the customer(s) who made the **highest total payment**.

### âœ… Solution

```sql
SELECT c.first_name, c.last_name, p.total_amount
FROM customer c
JOIN (
    SELECT customer_id, SUM(amount) AS total_amount
    FROM payment
    GROUP BY customer_id
) p
ON c.customer_id = p.customer_id
WHERE p.total_amount = (
    SELECT MAX(total_amount)
    FROM (
        SELECT SUM(amount) AS total_amount
        FROM payment
        GROUP BY customer_id
    ) t
);
```

### ğŸ§  Why nested subquery?

* You **cannot** use `MAX(SUM(amount))` directly
* Different aggregation levels require nesting

---

## ğŸ”Ÿ Advanced: Subquery inside Subquery (HARD ğŸ”¥)

### â“ Question

Find customers whose **total payment amount** is greater than the
**average total payment per customer**.

### ğŸ§  This requires:

* Aggregation level 1 â†’ total per customer
* Aggregation level 2 â†’ average of those totals

### âœ… Solution

```sql
SELECT c.first_name, c.last_name, p.total_sum
FROM customer c
JOIN (
    SELECT customer_id, SUM(amount) AS total_sum
    FROM payment
    GROUP BY customer_id
) p
ON c.customer_id = p.customer_id
WHERE p.total_sum > (
    SELECT AVG(total_sum)
    FROM (
        SELECT SUM(amount) AS total_sum
        FROM payment
        GROUP BY customer_id
    ) t
);
```

### ğŸ· Difficulty

**Advanced / Interview-Level**

---

## ğŸ§  Core Patterns to Remember

### âœ… Pattern 1: Average of grouped results

```sql
SELECT AVG(grouped_value)
FROM (
    SELECT AGG_FUNC(column) AS grouped_value
    FROM table
    GROUP BY key
) t;
```

### âœ… Pattern 2: FROM-clause subquery = analytics weapon

* Faster
* Cleaner
* Scales better

---

## ğŸ Summary

| Topic                    | Status      |
| ------------------------ | ----------- |
| IN Subquery              | âœ…           |
| EXISTS                   | âœ…           |
| Correlated Subquery      | âœ…           |
| FROM-Clause Subquery     | âœ…           |
| Subquery inside Subquery | ğŸ”¥ MASTERED |

---

If you want next:

* ğŸ“„ **Full GitHub README (all subqueries together)**
* ğŸ¯ **Interview-only SQL subquery questions**
* âš¡ **Performance comparison: JOIN vs EXISTS vs IN**

Just say the word ğŸ‘Š


