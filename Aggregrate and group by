SQL Aggregations & Grouping ‚Äî Theory Notes

These notes cover GROUP BY, aggregate functions, ORDER BY on aggregates, DATE extraction, and LIMIT, based on hands-on practice.

1Ô∏è‚É£ Aggregate Functions (The ‚ÄúMath‚Äù of SQL)

Aggregate functions perform calculations on multiple rows and return one value per group.

Common Aggregates
Function	Meaning
COUNT()	Number of rows
SUM()	Total value
AVG()	Average value
ROUND()	Rounds numeric output
Example
SELECT COUNT(payment_id) FROM payment;


‚û°Ô∏è Total number of payments.

2Ô∏è‚É£ GROUP BY ‚Äî Turning Rows into Insights

GROUP BY groups rows that have the same value and applies aggregates per group.

Rule (VERY IMPORTANT)

Every column in SELECT must either be aggregated or appear in GROUP BY

Example
SELECT staff_id, COUNT(payment_id)
FROM payment
GROUP BY staff_id;


‚û°Ô∏è One row per staff member showing how many payments they handled.

3Ô∏è‚É£ GROUP BY with Multiple Columns

You can group on combinations of columns.

Example
SELECT customer_id, staff_id, SUM(amount)
FROM payment
GROUP BY customer_id, staff_id;


‚û°Ô∏è Total amount paid per customer per staff member.

üß† Mental model:

Each unique (customer_id, staff_id) pair becomes one row.

4Ô∏è‚É£ ORDER BY with Aggregates

You can sort results using aggregate values.

Example
SELECT customer_id, SUM(amount)
FROM payment
GROUP BY customer_id
ORDER BY SUM(amount) DESC;


‚û°Ô∏è Customers ranked by total spending.

üìå Tip:

You can also use column position or alias, but writing SUM(amount) is clearest.

5Ô∏è‚É£ LIMIT ‚Äî Top N Analysis

Used to restrict result size after sorting.

Example
SELECT customer_id, SUM(amount)
FROM payment
GROUP BY customer_id
ORDER BY SUM(amount) DESC
LIMIT 5;


‚û°Ô∏è Top 5 highest-paying customers.

This pattern is extremely common in analytics and interviews.

6Ô∏è‚É£ GROUP BY with Dates (Time-Based Analysis)

Dates are often grouped by day, month, or year.

Extract date from timestamp
SELECT DATE(payment_date) FROM payment;

Daily aggregates
SELECT DATE(payment_date), SUM(amount)
FROM payment
GROUP BY DATE(payment_date);


‚û°Ô∏è Total revenue per day.

7Ô∏è‚É£ COUNT vs COUNT(column)

Important distinction:

Query	Meaning
COUNT(*)	Counts all rows
COUNT(amount)	Counts non-NULL amounts

In your dataset, amount is NOT NULL, so both behave similarly ‚Äî but this matters in real data.

8Ô∏è‚É£ AVG and ROUND for Clean Results

Averages often produce long decimals.

Example
SELECT rating, ROUND(AVG(replacement_cost), 2)
FROM film
GROUP BY rating;


‚û°Ô∏è Average replacement cost per rating, rounded to 2 decimals.

üìå Rule:

ROUND() is applied after aggregation.

9Ô∏è‚É£ ORDER BY Multiple Aggregates

You can sort by more than one metric.

Example
SELECT DATE(payment_date), COUNT(amount), SUM(amount)
FROM payment
GROUP BY DATE(payment_date)
ORDER BY COUNT(amount), SUM(amount);


‚û°Ô∏è Days sorted by number of transactions, then revenue.

üîÅ Core Patterns You Learned Today

These are real Data Engineering / Analytics patterns:

üü¢ Top N customers by spend

üü¢ Staff performance analysis

üü¢ Daily revenue aggregation

üü¢ Category-based averages

üü¢ Multi-dimensional grouping

üß† One-Line Summary

GROUP BY answers ‚Äúper what?‚Äù ‚Äî and aggregates answer ‚Äúhow much / how many?‚Äù

-- Which day had the most number of payments?

-- SELECT DATE(payment_date) , COUNT(payment_id)
-- FROM payment
-- GROUP BY DATE(payment_date)
-- ORDER BY COUNT(payment_id) DESC
-- LIMIT 1;


-- Which customer made the highest total payment?

-- SELECT customer_id , SUM(amount) 
-- FROM payment
-- GROUP BY customer_id 
-- ORDER BY SUM(amount) DESC
-- LIMIT 1;

-- Which staff member handled the most transactions?

-- SELECT staff_id , COUNT(amount) 
-- FROM payment
-- GROUP BY staff_id 
-- ORDER BY COUNT(amount)  DESC
-- LIMIT 1;


-- Which rating category is most expensive on average?

-- SELECT rating , ROUND(AVG(rental_rate) , 2)
-- FROM film
-- GROUP BY rating 
-- ORDER BY AVG(rental_rate) DESC
-- LIMIT 1;

-- Are there days where many payments happened but revenue was low?

-- SELECT DATE(payment_date)  , COUNT(*) , SUM(amount)
-- FROM payment
-- GROUP BY DATE(payment_date)
-- ORDER BY COUNT(*) DESC , SUM(amount) ASC;
